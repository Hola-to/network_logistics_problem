version: "3.8"

x-common-env: &common-env
  LOGISTICS_APP_ENVIRONMENT: development
  LOGISTICS_LOG_LEVEL: debug
  LOGISTICS_LOG_FORMAT: text
  LOGISTICS_TRACING_ENABLED: "false"

x-database-env: &database-env
  LOGISTICS_DATABASE_DRIVER: postgres
  LOGISTICS_DATABASE_HOST: postgres
  LOGISTICS_DATABASE_PORT: "5432"
  LOGISTICS_DATABASE_USERNAME: logistics
  LOGISTICS_DATABASE_PASSWORD: logistics
  LOGISTICS_DATABASE_DATABASE: logistics
  LOGISTICS_DATABASE_SSL_MODE: disable
  LOGISTICS_DATABASE_AUTO_MIGRATE: "true"

services:
  # Инфраструктура
  postgres:
    image: postgres:18-alpine
    container_name: logistics-postgres-dev
    environment:
      POSTGRES_USER: logistics
      POSTGRES_PASSWORD: logistics
      POSTGRES_DB: logistics
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logistics"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - logistics-dev-net

  redis:
    image: redis:8.4-alpine
    container_name: logistics-redis-dev
    ports:
      - "6379:6379"
    networks:
      - logistics-dev-net

  # Сервисы
  solver-svc:
    build:
      context: .
      dockerfile: services/solver-svc/Dockerfile.dev
    container_name: logistics-solver-dev
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: solver-svc
      LOGISTICS_GRPC_PORT: 50054
      LOGISTICS_METRICS_PORT: 8054
      LOGISTICS_CACHE_ENABLED: "true"
      LOGISTICS_CACHE_DRIVER: memory
    ports:
      - "50054:50054"
      - "8054:8054"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  validation-svc:
    build:
      context: .
      dockerfile: services/validation-svc/Dockerfile.dev
    container_name: logistics-validation-dev
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: validation-svc
      LOGISTICS_GRPC_PORT: 50052
      LOGISTICS_METRICS_PORT: 8052
    ports:
      - "50052:50052"
      - "8052:8052"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  analytics-svc:
    build:
      context: .
      dockerfile: services/analytics-svc/Dockerfile.dev
    container_name: logistics-analytics-dev
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: analytics-svc
      LOGISTICS_GRPC_PORT: 50053
      LOGISTICS_METRICS_PORT: 8053
    ports:
      - "50053:50053"
      - "8053:8053"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  auth-svc:
    build:
      context: .
      dockerfile: services/auth-svc/Dockerfile.dev
    container_name: logistics-auth-dev
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: auth-svc
      LOGISTICS_GRPC_PORT: 50055
      LOGISTICS_METRICS_PORT: 8055
      LOGISTICS_JWT_SECRET: dev-secret
    ports:
      - "50055:50055"
      - "8055:8055"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  history-svc:
    build:
      context: .
      dockerfile: services/history-svc/Dockerfile.dev
    container_name: logistics-history-dev
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: history-svc
      LOGISTICS_GRPC_PORT: 50056
      LOGISTICS_METRICS_PORT: 8056
    ports:
      - "50056:50056"
      - "8056:8056"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  audit-svc:
    build:
      context: .
      dockerfile: services/audit-svc/Dockerfile.dev
    container_name: logistics-audit-dev
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: audit-svc
      LOGISTICS_GRPC_PORT: 50057
      LOGISTICS_METRICS_PORT: 8057
    ports:
      - "50057:50057"
      - "8057:8057"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  simulation-svc:
    build:
      context: .
      dockerfile: services/simulation-svc/Dockerfile.dev
    container_name: logistics-simulation-dev
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: simulation-svc
      LOGISTICS_GRPC_PORT: 50058
      LOGISTICS_METRICS_PORT: 8088
      LOGISTICS_SERVICES_SOLVER_HOST: solver-svc
      LOGISTICS_SERVICES_SOLVER_PORT: 50054
    ports:
      - "50058:50058"
      - "8088:8088"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  report-svc:
    build:
      context: .
      dockerfile: services/report-svc/Dockerfile.dev
    container_name: logistics-report-dev
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: report-svc
      LOGISTICS_GRPC_PORT: 50059
      LOGISTICS_METRICS_PORT: 8059
    ports:
      - "50059:50059"
      - "8059:8059"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  gateway-svc:
    build:
      context: .
      dockerfile: services/gateway-svc/Dockerfile.dev
    container_name: logistics-gateway-dev
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: gateway-svc
      LOGISTICS_HTTP_PORT: 8080
      LOGISTICS_HTTP_CORS_ENABLED: "true"

      LOGISTICS_SERVICES_SOLVER_HOST: solver-svc
      LOGISTICS_SERVICES_SOLVER_PORT: 50054

      LOGISTICS_SERVICES_ANALYTICS_HOST: analytics-svc
      LOGISTICS_SERVICES_ANALYTICS_PORT: 50053

      LOGISTICS_SERVICES_VALIDATION_HOST: validation-svc
      LOGISTICS_SERVICES_VALIDATION_PORT: 50052

      LOGISTICS_SERVICES_HISTORY_HOST: history-svc
      LOGISTICS_SERVICES_HISTORY_PORT: 50056

      LOGISTICS_SERVICES_AUTH_HOST: auth-svc
      LOGISTICS_SERVICES_AUTH_PORT: 50055

      LOGISTICS_SERVICES_SIMULATION_HOST: simulation-svc
      LOGISTICS_SERVICES_SIMULATION_PORT: 50058

      LOGISTICS_SERVICES_REPORT_HOST: report-svc
      LOGISTICS_SERVICES_REPORT_PORT: 50059

      LOGISTICS_SERVICES_AUDIT_HOST: audit-svc
      LOGISTICS_SERVICES_AUDIT_PORT: 50057
    ports:
      - "8080:8080"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  web:
    image: node:20-alpine
    container_name: logistics-web-dev
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "3000:3000"
    volumes:
      - ./web:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - gateway-svc
    networks:
      - logistics-dev-net

volumes:
  postgres_dev_data:

networks:
  logistics-dev-net:
    driver: bridge
