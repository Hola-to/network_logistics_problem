# docker-compose.dev.yml

version: "3.8"

x-common-env: &common-env
  APP_ENV: development
  LOG_LEVEL: debug
  LOG_FORMAT: text
  TRACING_ENABLED: "false"

x-database-env: &database-env
  DATABASE_DRIVER: postgres
  DATABASE_HOST: postgres
  DATABASE_PORT: 5432
  DATABASE_USER: logistics
  DATABASE_PASSWORD: logistics
  DATABASE_NAME: logistics
  DATABASE_AUTO_MIGRATE: "true"

services:
  # ============================================================
  # Infrastructure
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: logistics-postgres-dev
    environment:
      POSTGRES_USER: logistics
      POSTGRES_PASSWORD: logistics
      POSTGRES_DB: logistics
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logistics"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - logistics-dev-net

  redis:
    image: redis:7-alpine
    container_name: logistics-redis-dev
    ports:
      - "6379:6379"
    networks:
      - logistics-dev-net

  # ============================================================
  # Backend Services (Development with hot-reload)
  # ============================================================
  solver-svc:
    build:
      context: .
      dockerfile: services/solver-svc/Dockerfile.dev
    container_name: logistics-solver-dev
    environment:
      <<: *common-env
      APP_NAME: solver-svc
      GRPC_PORT: 50054
      METRICS_PORT: 8054
      CACHE_ENABLED: "true"
      CACHE_DRIVER: memory
    ports:
      - "50054:50054"
      - "8054:8054"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  validation-svc:
    build:
      context: .
      dockerfile: services/validation-svc/Dockerfile.dev
    container_name: logistics-validation-dev
    environment:
      <<: *common-env
      APP_NAME: validation-svc
      GRPC_PORT: 50052
      METRICS_PORT: 8052
    ports:
      - "50052:50052"
      - "8052:8052"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  analytics-svc:
    build:
      context: .
      dockerfile: services/analytics-svc/Dockerfile.dev
    container_name: logistics-analytics-dev
    environment:
      <<: *common-env
      APP_NAME: analytics-svc
      GRPC_PORT: 50053
      METRICS_PORT: 8053
    ports:
      - "50053:50053"
      - "8053:8053"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

  auth-svc:
    build:
      context: .
      dockerfile: services/auth-svc/Dockerfile.dev
    container_name: logistics-auth-dev
    environment:
      <<: [*common-env, *database-env]
      APP_NAME: auth-svc
      GRPC_PORT: 50055
      METRICS_PORT: 8055
      JWT_SECRET: dev-secret
    ports:
      - "50055:50055"
      - "8055:8055"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  history-svc:
    build:
      context: .
      dockerfile: services/history-svc/Dockerfile.dev
    container_name: logistics-history-dev
    environment:
      <<: [*common-env, *database-env]
      APP_NAME: history-svc
      GRPC_PORT: 50056
      METRICS_PORT: 8056
    ports:
      - "50056:50056"
      - "8056:8056"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  audit-svc:
    build:
      context: .
      dockerfile: services/audit-svc/Dockerfile.dev
    container_name: logistics-audit-dev
    environment:
      <<: [*common-env, *database-env]
      APP_NAME: audit-svc
      GRPC_PORT: 50057
      METRICS_PORT: 8057
    ports:
      - "50057:50057"
      - "8057:8057"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  simulation-svc:
    build:
      context: .
      dockerfile: services/simulation-svc/Dockerfile.dev
    container_name: logistics-simulation-dev
    environment:
      <<: [*common-env, *database-env]
      APP_NAME: simulation-svc
      GRPC_PORT: 50058
      METRICS_PORT: 8088
      SERVICES_SOLVER_HOST: solver-svc
      SERVICES_SOLVER_PORT: 50054
    ports:
      - "50058:50058"
      - "8088:8088"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  report-svc:
    build:
      context: .
      dockerfile: services/report-svc/Dockerfile.dev
    container_name: logistics-report-dev
    environment:
      <<: [*common-env, *database-env]
      APP_NAME: report-svc
      GRPC_PORT: 50059
      METRICS_PORT: 8059
    ports:
      - "50059:50059"
      - "8059:8059"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-dev-net

  gateway-svc:
    build:
      context: .
      dockerfile: services/gateway-svc/Dockerfile.dev
    container_name: logistics-gateway-dev
    environment:
      <<: *common-env
      APP_NAME: gateway-svc
      HTTP_PORT: 8080
      CORS_ENABLED: "true"
      CORS_ALLOWED_ORIGINS: "*"
      SERVICES_SOLVER_HOST: solver-svc
      SERVICES_SOLVER_PORT: 50054
      SERVICES_ANALYTICS_HOST: analytics-svc
      SERVICES_ANALYTICS_PORT: 50053
      SERVICES_VALIDATION_HOST: validation-svc
      SERVICES_VALIDATION_PORT: 50052
      SERVICES_HISTORY_HOST: history-svc
      SERVICES_HISTORY_PORT: 50056
      SERVICES_AUTH_HOST: auth-svc
      SERVICES_AUTH_PORT: 50055
      SERVICES_SIMULATION_HOST: simulation-svc
      SERVICES_SIMULATION_PORT: 50058
      SERVICES_REPORT_HOST: report-svc
      SERVICES_REPORT_PORT: 50059
      SERVICES_AUDIT_HOST: audit-svc
      SERVICES_AUDIT_PORT: 50057
    ports:
      - "8080:8080"
    volumes:
      - .:/app
    networks:
      - logistics-dev-net

volumes:
  postgres_dev_data:

networks:
  logistics-dev-net:
    driver: bridge
