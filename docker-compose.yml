version: "3.8"

x-common-env: &common-env
  LOGISTICS_APP_ENVIRONMENT: development
  LOGISTICS_LOG_LEVEL: debug
  LOGISTICS_LOG_FORMAT: text
  LOGISTICS_TRACING_ENABLED: "true"
  LOGISTICS_TRACING_ENDPOINT: http://jaeger:4318

x-database-env: &database-env
  LOGISTICS_DATABASE_DRIVER: postgres
  LOGISTICS_DATABASE_HOST: postgres
  LOGISTICS_DATABASE_PORT: "5432"
  LOGISTICS_DATABASE_USERNAME: logistics
  LOGISTICS_DATABASE_PASSWORD: logistics
  LOGISTICS_DATABASE_DATABASE: logistics
  LOGISTICS_DATABASE_SSL_MODE: disable
  LOGISTICS_DATABASE_AUTO_MIGRATE: "true"

services:
  # ============================================================
  # Infrastructure (Переменные здесь стандартные, префикс не нужен)
  # ============================================================
  postgres:
    image: postgres:18-alpine
    container_name: logistics-postgres
    environment:
      POSTGRES_USER: logistics
      POSTGRES_PASSWORD: logistics
      POSTGRES_DB: logistics
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logistics -d logistics"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - logistics-net

  redis:
    image: redis:8.4-alpine
    container_name: logistics-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - logistics-net

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: logistics-jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
    networks:
      - logistics-net

  prometheus:
    image: prom/prometheus:main
    container_name: logistics-prometheus
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - logistics-net

  grafana:
    image: grafana/grafana:main
    container_name: logistics-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deploy/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - logistics-net

  # ============================================================
  # Backend Services
  # ============================================================
  solver-svc:
    build:
      context: .
      dockerfile: services/solver-svc/Dockerfile
    container_name: logistics-solver
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: solver-svc
      LOGISTICS_GRPC_PORT: 50054
      LOGISTICS_METRICS_PORT: 8054
      LOGISTICS_CACHE_ENABLED: "true"
      LOGISTICS_CACHE_DRIVER: redis
      # Исправлено: CacheConfig требует host и port отдельно, а не addr
      LOGISTICS_CACHE_HOST: redis
      LOGISTICS_CACHE_PORT: 6379
      LOGISTICS_CACHE_DEFAULT_TTL: 5m
    ports:
      - "50054:50054"
      - "8054:8054"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - logistics-net
    restart: unless-stopped

  validation-svc:
    build:
      context: .
      dockerfile: services/validation-svc/Dockerfile
    container_name: logistics-validation
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: validation-svc
      LOGISTICS_GRPC_PORT: 50052
      LOGISTICS_METRICS_PORT: 8052
    ports:
      - "50052:50052"
      - "8052:8052"
    networks:
      - logistics-net
    restart: unless-stopped

  analytics-svc:
    build:
      context: .
      dockerfile: services/analytics-svc/Dockerfile
    container_name: logistics-analytics
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: analytics-svc
      LOGISTICS_GRPC_PORT: 50053
      LOGISTICS_METRICS_PORT: 8053
    ports:
      - "50053:50053"
      - "8053:8053"
    networks:
      - logistics-net
    restart: unless-stopped

  auth-svc:
    build:
      context: .
      dockerfile: services/auth-svc/Dockerfile
    container_name: logistics-auth
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: auth-svc
      LOGISTICS_GRPC_PORT: 50055
      LOGISTICS_METRICS_PORT: 8055
      # JWT обычно не в struct Config, но если используется напрямую через os.Getenv, оставьте как есть.
      # Если через Config, добавьте префикс. Для надежности добавляем префикс.
      LOGISTICS_JWT_SECRET: super-secret-key-change-in-production
      LOGISTICS_JWT_ACCESS_EXPIRY: 15m
      LOGISTICS_JWT_REFRESH_EXPIRY: 168h
    ports:
      - "50055:50055"
      - "8055:8055"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-net
    restart: unless-stopped

  history-svc:
    build:
      context: .
      dockerfile: services/history-svc/Dockerfile
    container_name: logistics-history
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: history-svc
      LOGISTICS_GRPC_PORT: 50056
      LOGISTICS_METRICS_PORT: 8056
    ports:
      - "50056:50056"
      - "8056:8056"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-net
    restart: unless-stopped

  audit-svc:
    build:
      context: .
      dockerfile: services/audit-svc/Dockerfile
    container_name: logistics-audit
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: audit-svc
      LOGISTICS_GRPC_PORT: 50057
      LOGISTICS_METRICS_PORT: 8057
    ports:
      - "50057:50057"
      - "8057:8057"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-net
    restart: unless-stopped

  simulation-svc:
    build:
      context: .
      dockerfile: services/simulation-svc/Dockerfile
    container_name: logistics-simulation
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: simulation-svc
      LOGISTICS_GRPC_PORT: 50058
      LOGISTICS_METRICS_PORT: 8088
      # Discovery settings
      LOGISTICS_SERVICES_SOLVER_HOST: solver-svc
      LOGISTICS_SERVICES_SOLVER_PORT: 50054
    ports:
      - "50058:50058"
      - "8088:8088"
    depends_on:
      postgres:
        condition: service_healthy
      solver-svc:
        condition: service_started
    networks:
      - logistics-net
    restart: unless-stopped

  report-svc:
    build:
      context: .
      dockerfile: services/report-svc/Dockerfile
    container_name: logistics-report
    environment:
      <<: [*common-env, *database-env]
      LOGISTICS_APP_NAME: report-svc
      LOGISTICS_GRPC_PORT: 50059
      LOGISTICS_METRICS_PORT: 8059
      LOGISTICS_REPORT_DEFAULT_TTL: 24h
      LOGISTICS_REPORT_CLEANUP_INTERVAL: 1h
    ports:
      - "50059:50059"
      - "8059:8059"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - logistics-net
    restart: unless-stopped

  gateway-svc:
    build:
      context: .
      dockerfile: services/gateway-svc/Dockerfile
    container_name: logistics-gateway
    environment:
      <<: *common-env
      LOGISTICS_APP_NAME: gateway-svc
      LOGISTICS_HTTP_PORT: 8080
      LOGISTICS_HTTP_CORS_ENABLED: "true"
      # CORS allowed origins - список строк
      # LOGISTICS_HTTP_CORS_ALLOWED_ORIGINS: "*"

      # Service Discovery
      LOGISTICS_SERVICES_SOLVER_HOST: solver-svc
      LOGISTICS_SERVICES_SOLVER_PORT: 50054

      LOGISTICS_SERVICES_ANALYTICS_HOST: analytics-svc
      LOGISTICS_SERVICES_ANALYTICS_PORT: 50053

      LOGISTICS_SERVICES_VALIDATION_HOST: validation-svc
      LOGISTICS_SERVICES_VALIDATION_PORT: 50052

      LOGISTICS_SERVICES_HISTORY_HOST: history-svc
      LOGISTICS_SERVICES_HISTORY_PORT: 50056

      LOGISTICS_SERVICES_AUTH_HOST: auth-svc
      LOGISTICS_SERVICES_AUTH_PORT: 50055

      LOGISTICS_SERVICES_SIMULATION_HOST: simulation-svc
      LOGISTICS_SERVICES_SIMULATION_PORT: 50058

      LOGISTICS_SERVICES_REPORT_HOST: report-svc
      LOGISTICS_SERVICES_REPORT_PORT: 50059

      LOGISTICS_SERVICES_AUDIT_HOST: audit-svc
      LOGISTICS_SERVICES_AUDIT_PORT: 50057
    ports:
      - "8080:8080"
    depends_on:
      - solver-svc
      - validation-svc
      - analytics-svc
      - auth-svc
      - history-svc
      - audit-svc
      - simulation-svc
      - report-svc
    networks:
      - logistics-net
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: logistics-web
    ports:
      - "8081:8081"
    depends_on:
      - gateway-svc
    networks:
      - logistics-net
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  logistics-net:
    driver: bridge
